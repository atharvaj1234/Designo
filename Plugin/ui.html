<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Design Assistant</title>
    <style>
      /* --- Base styles remain the same --- */
      body { font-family: sans-serif; margin: 0; background-color: #f0f0f0; color: #333; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; }
      .container { display: flex; flex-direction: column; flex-grow: 1; padding: 15px; gap: 10px; overflow: hidden; }
      h2 { margin-top: 0; margin-bottom: 10px; font-size: 18px; text-align: center;}
      #chat-history { flex-grow: 1; overflow-y: auto; background-color: #fff; border: 1px solid #ccc; border-radius: 5px; padding: 10px; margin-bottom: 10px; min-height: 150px; display: flex; flex-direction: column; gap: 8px; }
      .message { padding: 8px 12px; border-radius: 15px; max-width: 85%; word-wrap: break-word; line-height: 1.4; }
      .message.user { background-color: #0d99ff; color: white; align-self: flex-end; border-bottom-right-radius: 5px; }
      .message.ai { background-color: #e0e0e0; color: #333; align-self: flex-start; border-bottom-left-radius: 5px; } /* Can be used for backend error messages too */
      .message.status { background-color: #f0f0f0; color: #555; align-self: stretch; max-width: none; text-align: center; font-style: italic; font-size: 12px; border-radius: 4px; }
      .message.error { background-color: #ffebee; color: #d93025; border: 1px solid #d93025; align-self: stretch; max-width: none; font-weight: bold; }
      .message.success { background-color: #e6f4ea; color: #1e8e3e; border: 1px solid #1e8e3e; align-self: stretch; max-width: none; font-weight: bold; }
      .input-area { display: flex; gap: 10px; align-items: center; margin-top: auto; padding-top: 10px; border-top: 1px solid #eee; }
      textarea#prompt { flex-grow: 1; height: 60px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; resize: none; box-sizing: border-box; }
      button#send { padding: 10px 15px; background-color: #0d99ff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; transition: background-color 0.2s ease; white-space: nowrap; height: 40px; align-self: center; }
      button#send:hover { background-color: #0b7dd1; }
      button#send:disabled { background-color: #ccc; cursor: not-allowed; }
      /* REMOVED API Key label/input/small styles */
      .loader { border: 3px solid #f3f3f3; border-top: 3px solid #0d99ff; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; margin-left: 5px; vertical-align: middle; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <!-- REMOVED importmap for @google/generative-ai -->
  </head>
  <body>
    <div class="container">
      <h2>AI Design Assistant</h2>
      <!-- REMOVED API Key Input Section -->

      <div id="chat-history">
        <div class="message status" id="initial-message">
          Select an empty frame to generate a design, or select an element within a frame to modify it.
        </div>
      </div>

      <div class="input-area">
        <textarea
          id="prompt"
          placeholder="Select a target in Figma first..."
          disabled
        ></textarea>
        <button id="send" disabled>Send</button>
      </div>
    </div>

    <script type="module">
      // REMOVED import from "@google/generative-ai";

      // --- Config ---
      // Make sure this URL matches where your Python backend is running
      const BACKEND_URL = 'http://localhost:5001/generate';

      // --- UI Elements ---
      // REMOVED: apiKeyInput reference
      const chatHistory = document.getElementById("chat-history");
      const promptInput = document.getElementById("prompt");
      const sendButton = document.getElementById("send");
      const initialMessage = document.getElementById("initial-message");

      // --- State ---
      let currentMode = 'answer'; // 'create' or 'modify'
      let currentFrameId = null;
      let currentFrameName = null;
      let selectedElementInfo = null; // For modify mode context
      let isLoading = false;
      let currentProcessingMessage = null; // Message div showing loading status

      // Store temporary data needed between messages from code.js and sending to backend/code.js
      let pendingRequestData = null;

      // --- Helper Functions ---
      function addMessage(text, type = "status", isLoadingSpinner = false) {
        if (initialMessage && initialMessage.parentNode === chatHistory) {
          chatHistory.removeChild(initialMessage);
        }
        const messageDiv = document.createElement("div");
        messageDiv.classList.add("message", type);
        const textNode = document.createTextNode(text); // Basic text insertion
        messageDiv.appendChild(textNode);

        if (isLoadingSpinner) {
          const loader = document.createElement("div");
          loader.classList.add("loader");
          messageDiv.appendChild(loader);
        }
        chatHistory.appendChild(messageDiv);
        chatHistory.scrollTop = chatHistory.scrollHeight; // Scroll to bottom
        return messageDiv;
      }

       function setLoading(loading, statusText = null) {
            isLoading = loading;
            // No API key check needed anymore
            const hasPrompt = promptInput.value.trim();
            const canSend = !loading && currentMode && hasPrompt;

            sendButton.disabled = !canSend;
            promptInput.disabled = loading || !currentMode;

            // Clear previous processing message if starting new loading state
            if (loading && currentProcessingMessage) {
                const spinner = currentProcessingMessage.querySelector('.loader');
                if (spinner) spinner.remove();
                // Optionally change text of old message, or just leave it
                currentProcessingMessage = null;
            }

            if (loading && statusText) {
                // Create a new status message for this loading operation
                currentProcessingMessage = addMessage(statusText, "status", true);
            }
            // No need for an 'else' to clear spinner, handled above
        }


      // Still needed here to convert PNG bytes before sending to backend
      function uint8ArrayToBase64(bytes) {
        return new Promise((resolve, reject) => {
          const blob = new Blob([bytes], { type: "image/png" });
          const reader = new FileReader();
          reader.onload = () => {
            // result contains 'data:image/png;base64,<actual_base64_string>'
            const dataUrl = reader.result;
            const base64 = dataUrl.split(",")[1]; // Get only the base64 part
            if (!base64) {
                reject(new Error("Failed to extract Base64 string from Data URL."));
                return;
            }
            resolve(base64);
          };
          reader.onerror = (error) => reject(error);
          reader.readAsDataURL(blob);
        });
      }

        // Reset UI state (placeholders etc.)
        function resetUIState() {
            console.log("Resetting UI state.");
            // isLoading handled by setLoading
            pendingRequestData = null; // Clear pending data

            if (currentMode === "create") {
                 promptInput.placeholder = currentFrameName ? `Describe design for "${currentFrameName}"...` : "Select empty frame...";
            } else if (currentMode === "modify") {
                 promptInput.placeholder = selectedElementInfo ? `Describe change for "${selectedElementInfo.name}"...` : "Select element...";
            } else {
                 promptInput.placeholder = "Select a target in Figma first...";
            }
            setLoading(false); // Ensure UI is not stuck loading
        }

      // --- Input Handling ---
      // REMOVED: apiKeyInput.oninput
      promptInput.oninput = () => setLoading(isLoading); // Still update button state based on prompt
      promptInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey && !sendButton.disabled) {
                e.preventDefault();
                sendButton.click();
            }
        });


      // --- Call Backend Function ---
      async function callBackendApi(payload) {
          setLoading(true, "Communicating with AI Assistant Backend...");
          console.log("Sending to backend:", payload);

          try {
              const response = await fetch(BACKEND_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(payload),
              });

              if (!response.ok) {
                  // Try to get error message from backend response body
                  let errorMsg = `Backend request failed with status: ${response.status}`;
                  try {
                      const errorData = await response.json();
                      if (errorData && errorData.error) {
                          errorMsg = `Backend Error: ${errorData.error}`;
                      }
                  } catch (e) { /* Ignore JSON parse error if response wasn't JSON */ }
                  throw new Error(errorMsg);
              }

              const result = await response.json();
              console.log("Received from backend:", result);

              if (result.success && result.svg) {
                  // Backend succeeded, send SVG to code.js for insertion/replacement
                  if (payload.mode === 'create') {
                      parent.postMessage({ pluginMessage: {
                          type: 'finalize-creation',
                          svgContent: result.svg,
                          targetFrameId: pendingRequestData.targetFrameId // Get frameId from stored data
                      }}, '*');
                  } else if (payload.mode === 'modify') {
                       parent.postMessage({ pluginMessage: {
                          type: 'replace-element-with-svg',
                          svgContent: result.svg,
                          originalElementId: pendingRequestData.originalElementId // Get originalId from stored data
                      }}, '*');
                  }}
                  else if (payload.mode === 'answer') {
                    console.log("here in post")
                    parent.postMessage({ pluginMessage: {
                      type: 'answer',
                      answer: result.answer
                      }}, '*');
                  }
                   // setLoading(false) will happen when code.js sends success/error message back
              else {
                  // Backend reported an error
                  throw new Error(result.error || "Backend returned an unspecified error.");
              }

          } catch (error) {
              console.error("Error calling backend API:", error);
              const displayError = `Error: ${error.message || "Could not connect to backend."}`;
              addMessage(displayError, "error");
              // Send error up to code.js as well? Maybe just display here.
              // parent.postMessage({ pluginMessage: { type: 'modification-error', error: displayError }}, '*');
              setLoading(false); // Stop loading on fetch error
              resetUIState();
          } finally {
              pendingRequestData = null; // Clear pending data after attempt
          }
      }


      // --- Listen for Messages from Figma Code (code.js) ---
      window.onmessage = async (event) => {
        const message = event.data.pluginMessage;
        if (!message) return;

        console.log("Message received from code.js:", message.type);

        switch (message.type) {
          case "selection-update":
            resetUIState(); // Reset previous state
            currentMode = message.mode;
            currentFrameId = message.frameId; // Store for context if needed
            currentFrameName = message.frameName;
            selectedElementInfo = message.element; // Contains id, name, type, width, height

            if (currentMode === "create") {
              addMessage(`Selected empty frame "${currentFrameName}". Ready to generate.`, "status");
              promptInput.placeholder = `Describe the new design for "${currentFrameName}"...`;
            } else if (currentMode === "modify") {
               addMessage(`Selected element "${selectedElementInfo?.name || 'unknown'}" in frame "${currentFrameName}". Ready to modify.`, "status");
              promptInput.placeholder = `Describe change for "${selectedElementInfo?.name || 'element'}"...`;
            }
            setLoading(false); // Update enabled state
            break;

          case "selection-invalid":
            resetUIState();
            // currentMode = null;
            currentFrameId = null;
            currentFrameName = null;
            selectedElementInfo = null;
            currentMode = 'answer';
            // addMessage(message.reason || "Invalid selection.", "status");
            // promptInput.placeholder = "Select a target in Figma first...";
            setLoading(false);
            break;

          case "proceed-to-answer-text":
            console.log("here in switch")
            const ansPayload = {
                mode: 'answer',
                userPrompt: message.userPrompt,
                // context: message.context, // contains frameName
            };

            callBackendApi(ansPayload);
            break;


          // --- Messages FROM code.js telling UI TO CALL the backend ---
          case "proceed-to-backend-text":
              // Store data needed after backend responds
              pendingRequestData = { targetFrameId: message.targetFrameId, originalElementId: message.originalElementId };
              // Prepare payload for backend
              const textPayload = {
                  mode: 'create',
                  userPrompt: message.userPrompt,
                  context: message.context, // contains frameName
              };
              // Call the backend
              callBackendApi(textPayload);
              break;

          case "proceed-to-backend-vision":
              setLoading(true, "Encoding image data...");
              try {
                  const frameBase64Image = await uint8ArrayToBase64(message.framePngBytes);
                  const elementBase64Image = await uint8ArrayToBase64(message.elementPngBytes);
                  // console.log("base64:", base64Image)
                  // Store data needed after backend responds
                  console.log("element in ui", message.element)
                  pendingRequestData = { originalElementId: message.originalElement.id };
                   // Prepare payload for backend
                  const visionPayload = {
                      mode: 'modify',
                      userPrompt: message.userPrompt,
                      context: message.context, // contains frameName and elementInfo
                      frameDataBase64: frameBase64Image,
                      elementDataBase64: elementBase64Image,
                      element: message.originalElement,
                  };
                  // Call the backend
                  callBackendApi(visionPayload);

              } catch (conversionError) {
                  console.error("Base64 Conversion Error:", conversionError);
                  addMessage(`Error processing frame image: ${conversionError.message}`, "error");
                  setLoading(false);
                  resetUIState();
              }
              break;

          // --- Success/Error/Status Callbacks FROM code.js (after insertion/replacement attempt) ---
          case "creation-success":
            addMessage(`✅ Success! New design added to frame "${currentFrameName}".`, "success");
            setLoading(false);
            promptInput.value = ""; // Clear prompt
            resetUIState();
            break;

          case "modification-success":
             addMessage(`✅ Success! Element updated in frame "${currentFrameName}".`, "success");
            setLoading(false);
            promptInput.value = "";
            resetUIState();
            break;

          case "modification-error": // Error reported by code.js (insertion/replacement failed) OR forwarded from backend
            addMessage(`❌ Error: ${message.error}`, "error");
            setLoading(false);
            resetUIState();
            break;

          case "status-update": // Status messages from code.js (e.g., exporting, importing)
             if (message.isLoading) {
                 setLoading(true, message.text);
             } else {
                 // If it's just an informational status update:
                 addMessage(`ℹ️ ${message.text}`, "status");
                 if (isLoading) setLoading(false); // Ensure loading stops if needed
             }
            break;

          default:
             console.warn("Unknown message type received from code.js:", message.type);
             break;
        }
      };

      // --- Send Button Logic ---
      sendButton.onclick = () => {
        const userPrompt = promptInput.value.trim();
        // REMOVED: apiKey check

        // if (!currentMode || !currentFrameId) {
        //    addMessage("Please select a valid target in Figma first.", "error");
        //    return;
        // }
        if (!userPrompt) {
           addMessage("Please enter a description or instruction.", "error");
           promptInput.focus();
           return;
        }

        addMessage(userPrompt, "user"); // Display user's prompt
        setLoading(true, "Preparing request..."); // Initial status

        // Send request to code.js to start the process (exporting etc.)
        parent.postMessage(
          {
            pluginMessage: {
              type: "request-ai-generation", // This message type remains the same
              mode: currentMode,
              frameId: currentFrameId || null,
              userPrompt: userPrompt,
              elementInfo: selectedElementInfo || null, // Send element context for modify mode
              // API Key is NOT sent anymore
            },
          },
          "*"
        );
      };

      // --- REMOVED AI Call Functions (callTextAI_Generate, callVisionAI, handleAiError) ---

      // --- Initial State ---
      setLoading(false); // Start UI ready (pending selection)

    </script>
  </body>
</html>